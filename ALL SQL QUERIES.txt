-- Step 1: Create the database first
CREATE OR REPLACE DATABASE CUSTOMER_DATA;

-- Step 2: Use the new database
USE DATABASE CUSTOMER_DATA;

-- Step 3: Now create the schema inside it
CREATE OR REPLACE SCHEMA CUSTOMER_SCHEMA;

USE DATABASE CUSTOMER_DATA;
USE SCHEMA CUSTOMER_SCHEMA;

SELECT *
FROM CUSTOMER_DATA.CUSTOMER_SCHEMA.CUSTOMERS_RAW

--MAPPING
INSERT INTO customers_parsed
SELECT
  CAST(GET_PATH(raw_data, 'customer_id') AS INT) AS customer_id,
  CAST(GET_PATH(raw_data, 'customer_name') AS STRING) AS customer_name,
  CAST(GET_PATH(raw_data, 'email') AS STRING) AS email,
  CAST(
    SPLIT_PART(REPLACE(GET_PATH(raw_data, 'join_date')::STRING, '"', ''), 'T', 1)
    AS DATE
  ) AS join_date,
  CASE
    WHEN LOWER(GET_PATH(raw_data, 'active')::STRING) = 'true' THEN TRUE
    ELSE FALSE
  END AS active
FROM customers_raw;

SELECT * FROM CUSTOMER_DATA.CUSTOMER_SCHEMA.CUSTOMERS_PARSED

--SCD1

SELECT *
FROM CUSTOMER_DATA.CUSTOMER_SCHEMA.CUSTOMERS_PARSED

UPDATE CUSTOMER_DATA.CUSTOMER_SCHEMA.CUSTOMERS_PARSED
SET EMAIL = 'new_email@example.com'
WHERE CUSTOMER_ID = '6';


SELECT *
FROM CUSTOMER_DATA.CUSTOMER_SCHEMA.SCD1_CUSTOMERS

--SCD2

UPDATE CUSTOMER_DATA.CUSTOMER_SCHEMA.CUSTOMERS_PARSED
SET email = 'keith.final_test_123@example.com'
WHERE customer_id = 22;

SELECT * FROM CUSTOMER_DATA.CUSTOMER_SCHEMA.SCD2_CUSTOMERS;

--SCD3
UPDATE CUSTOMER_DATA.CUSTOMER_SCHEMA.CUSTOMERS_PARSED
SET email = 'scd3.newemail@example.com'
WHERE customer_id = 30;

SELECT * FROM CUSTOMER_DATA.CUSTOMER_SCHEMA.SCD3_CUSTOMERS
WHERE customer_id = 30;

--SCD4
UPDATE CUSTOMER_DATA.CUSTOMER_SCHEMA.CUSTOMERS_PARSED
SET email = 'test.scd4_update@example.com'
WHERE customer_id = 70;

SELECT *
FROM CUSTOMER_DATA.CUSTOMER_SCHEMA.CUSTOMERS_PARSED

SELECT *
FROM CUSTOMER_DATA.CUSTOMER_SCHEMA.SCD4_CUSTOMERS_CURRENT

SELECT *
FROM CUSTOMER_DATA.CUSTOMER_SCHEMA.SCD4_CUSTOMERS_HISTORY

--VIEW TESTING
SELECT *
FROM CUSTOMER_DATA.CUSTOMER_SCHEMA.LATEST_CUSTOMERS
WHERE CURRENT_FLAG = 'FALSE'


